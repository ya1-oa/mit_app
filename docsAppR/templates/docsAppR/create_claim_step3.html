{% extends "account/base.html" %}

{% block title %}Create Claim - Step 3{% endblock %}
{% block page_title %}Create New Claim - Step 3{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-10 mx-auto">

            <!-- Stepper -->
            <div class="stepper mb-4">
                <div class="stepper-item completed">
                    <div class="stepper-icon"><i class="fas fa-check"></i></div>
                    <div class="stepper-label">Client Info</div>
                </div>
                <div class="stepper-item completed">
                    <div class="stepper-icon"><i class="fas fa-check"></i></div>
                    <div class="stepper-label">Rooms</div>
                </div>
                <div class="stepper-item active">
                    <div class="stepper-icon">3</div>
                    <div class="stepper-label">Review & Create</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-check-circle"></i> Step 3: Review & Create Claim
                    </h4>
                </div>
                <div class="card-body">

                    <!-- Client Summary -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-user"></i> Client Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Property Owner:</dt>
                                        <dd class="col-sm-7">{{ client.pOwner }}</dd>

                                        <dt class="col-sm-5">Address:</dt>
                                        <dd class="col-sm-7">
                                            {{ client.pAddress }}<br>
                                            {{ client.pCityStateZip }}
                                        </dd>

                                        <dt class="col-sm-5">Email:</dt>
                                        <dd class="col-sm-7">{{ client.cEmail|default:"—" }}</dd>

                                        <dt class="col-sm-5">Phone:</dt>
                                        <dd class="col-sm-7">{{ client.cPhone|default:"—" }}</dd>
                                    </dl>
                                </div>

                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Insurance Co:</dt>
                                        <dd class="col-sm-7">{{ client.insuranceCo_Name }}</dd>

                                        <dt class="col-sm-5">Claim #:</dt>
                                        <dd class="col-sm-7">{{ client.claimNumber }}</dd>

                                        <dt class="col-sm-5">Cause of Loss:</dt>
                                        <dd class="col-sm-7">{{ client.get_causeOfLoss_display|default:"—" }}</dd>

                                        <dt class="col-sm-5">Date of Loss:</dt>
                                        <dd class="col-sm-7">{{ client.dateOfLoss|default:"—" }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="text-end">
                                <a href="{% url 'create_claim_step1' %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i> Edit Client Info
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Server Folder Structure Preview -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-server"></i> Server Folder Structure to be Created
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                The following will be created automatically on the server:
                            </div>

                            <div style="font-family: monospace; font-size: 13px; line-height: 1.8;">
                                <div><i class="fas fa-folder text-primary"></i> <strong>Server/claims/</strong></div>
                                <div class="ms-3"><i class="fas fa-folder text-warning"></i> <strong>{{ client.pOwner }}@{{ client.pAddress }}</strong></div>
                                <div class="ms-5"><i class="fas fa-file-excel text-success"></i> 01-INFO-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5"><i class="fas fa-file-pdf text-danger"></i> w9.pdf</div>

                                <!-- EXT EMS Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> EXT EMS {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>

                                <!-- MIT Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> MIT {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>

                                <!-- CPS Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> CPS {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>

                                <!-- BASIC DOCS OUT Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> BASIC DOCS OUT {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>

                                <!-- REBUILD Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> REBUILD {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>

                                <!-- Templates Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-info"></i> <strong>Templates {{ client.pOwner }}@{{ client.pAddress }}</strong></div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 01-ROOMS-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 02-INS-CO-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 30-MASTER-Insurer-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 50-2-CONTRACT-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 51-NOTARY-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 60_scope_form-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 60-SCOPE-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 82-MIT 3-DAY-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 82-MIT-3DAY-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 82-MIT-5DAY-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 82-MIT-7DAY-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 92-CPS-LABELS-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 92-MOBILE-CPS-LABELS-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-info"></i> 94-2-CPS-INVOICE-{{ client.pOwner }}@{{ client.pAddress }}.xlsm</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 998-Release-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file-excel text-success"></i> 1000-ALL-CLAIMS-{{ client.pOwner }}@{{ client.pAddress }}.xlsx</div>

                                <!-- BU Folder -->
                                <div class="ms-5 mt-2"><i class="fas fa-folder text-warning"></i> BU {{ client.pOwner }}@{{ client.pAddress }}</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> FINAL V2</div>
                                <div class="ms-5 ps-4"><i class="fas fa-folder text-secondary"></i> SPLM</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> .0 EMAIL #1.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 7. EMAIL #2.txt</div>
                                <div class="ms-5 ps-4"><i class="fas fa-file text-muted"></i> 11. OTHER #3.txt</div>
                            </div>

                            <div class="alert alert-success mt-3 mb-0">
                                <i class="fas fa-check-circle"></i> <strong>Total:</strong> 7 main folders, 12 subfolders, 21 text files, and 17 Excel templates with auto-populated data
                            </div>
                        </div>
                    </div>

                    <!-- Confirmation -->
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h4 class="text-success mb-3">
                                <i class="fas fa-check-circle"></i> Ready to Create
                            </h4>
                            <p class="text-muted mb-3">Clicking "Create Claim" will automatically:</p>
                            <ul class="text-start d-inline-block mb-4">
                                <li>Save all claim information to database</li>
                                <li>Create complete server folder structure</li>
                                <li>Generate all Excel templates with populated data</li>
                                <li>Generate room labels PDF &amp; email to team</li>
                                <li>Send room list email to team</li>
                                <li>Push claim &amp; room lists to Encircle</li>
                            </ul>

                            <form method="post" id="create-claim-form" class="mt-2">
                                {% csrf_token %}

                                <!-- Encircle Room List Selection -->
                                <div class="text-start d-inline-block mb-4 p-3 border rounded bg-light" style="min-width:340px;">
                                    <p class="fw-semibold mb-2 text-primary small">
                                        <i class="fas fa-list-ul me-1"></i> Encircle Room Lists to Generate
                                    </p>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox"
                                               name="encircle_templates" value="basic"
                                               id="tpl-basic">
                                        <label class="form-check-label small" for="tpl-basic">
                                            <strong>100-700s Complete Room List</strong>
                                            <span class="text-muted d-block" style="font-size:0.78rem;">Overview, source, CPS, PPR, demo, mitigation, HMR</span>
                                        </label>
                                    </div>
                                    <div class="form-check mb-1">
                                        <input class="form-check-input" type="checkbox"
                                               name="encircle_templates" value="readings"
                                               id="tpl-readings">
                                        <label class="form-check-label small" for="tpl-readings">
                                            8000-9000s MC Day Readings
                                            <span class="text-muted d-block" style="font-size:0.78rem;">Day 1-4 MC Readings + Dry Chambers</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="encircle_templates" value="readings default"
                                               id="tpl-readings-default">
                                        <label class="form-check-label small" for="tpl-readings-default">
                                            70000s Stabilization Readings
                                            <span class="text-muted d-block" style="font-size:0.78rem;">Day 0 MC Readings</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-center gap-3">
                                    <a href="{% url 'create_claim_step2' %}" class="btn btn-secondary btn-lg" id="back-btn">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </a>
                                    <button type="submit" class="btn btn-success btn-lg" id="create-btn">
                                        <i class="fas fa-rocket"></i> Create Claim
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Loading overlay (shown on submit) -->
                    <div id="creating-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:9999; align-items:center; justify-content:center;">
                        <div style="background:#fff; border-radius:16px; padding:36px 40px; max-width:480px; width:92%; box-shadow:0 8px 40px rgba(0,0,0,0.3);">
                            <h4 class="text-center mb-4" style="color:#1e88e5;">
                                <i class="fas fa-rocket me-2"></i> Creating Claim…
                            </h4>
                            <ul class="list-unstyled mb-0" id="task-list">
                                <li class="task-item d-flex align-items-center gap-3 py-2 border-bottom" data-key="db">
                                    <span class="task-icon"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Saving claim to database</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                                <li class="task-item d-flex align-items-center gap-3 py-2 border-bottom" data-key="email">
                                    <span class="task-icon text-secondary"><i class="fas fa-circle" style="font-size:.5rem;opacity:.4;"></i></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Sending room list email to team</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                                <li class="task-item d-flex align-items-center gap-3 py-2 border-bottom" data-key="folder">
                                    <span class="task-icon text-secondary"><i class="fas fa-circle" style="font-size:.5rem;opacity:.4;"></i></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Creating server folder structure</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                                <li class="task-item d-flex align-items-center gap-3 py-2 border-bottom" data-key="templates">
                                    <span class="task-icon text-secondary"><i class="fas fa-circle" style="font-size:.5rem;opacity:.4;"></i></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Generating Excel templates</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                                <li class="task-item d-flex align-items-center gap-3 py-2 border-bottom" data-key="labels">
                                    <span class="task-icon text-secondary"><i class="fas fa-circle" style="font-size:.5rem;opacity:.4;"></i></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Generating room labels</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                                <li class="task-item d-flex align-items-center gap-3 py-2" data-key="encircle">
                                    <span class="task-icon text-secondary"><i class="fas fa-circle" style="font-size:.5rem;opacity:.4;"></i></span>
                                    <div class="flex-grow-1">
                                        <span class="task-label">Pushing to Encircle</span>
                                        <div class="task-error text-danger small mt-1" style="display:none;"></div>
                                    </div>
                                </li>
                            </ul>
                            <p id="overlay-status" class="text-center mt-4 text-muted small"></p>
                        </div>
                    </div>

                    <style>
                    .task-item .task-icon { width: 24px; text-align:center; flex-shrink:0; }
                    </style>
                    <script>
                    (function() {
                        const form = document.getElementById('create-claim-form');
                        const overlay = document.getElementById('creating-overlay');
                        const createBtn = document.getElementById('create-btn');
                        const backBtn = document.getElementById('back-btn');
                        const statusP = document.getElementById('overlay-status');

                        function getItem(key) {
                            return document.querySelector(`.task-item[data-key="${key}"]`);
                        }
                        function setSpinner(key) {
                            const el = getItem(key);
                            if (!el) return;
                            el.querySelector('.task-icon').innerHTML =
                                '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
                        }
                        function setDone(key) {
                            const el = getItem(key);
                            if (!el) return;
                            el.querySelector('.task-icon').innerHTML =
                                '<i class="fas fa-check-circle text-success"></i>';
                        }
                        function setError(key, msg) {
                            const el = getItem(key);
                            if (!el) return;
                            el.querySelector('.task-icon').innerHTML =
                                '<i class="fas fa-times-circle text-danger"></i>';
                            const errDiv = el.querySelector('.task-error');
                            errDiv.textContent = msg || 'Failed';
                            errDiv.style.display = '';
                        }

                        form.addEventListener('submit', async function(e) {
                            e.preventDefault();

                            overlay.style.display = 'flex';
                            createBtn.disabled = true;
                            backBtn.style.pointerEvents = 'none';
                            backBtn.style.opacity = '0.5';

                            const fd = new FormData(form);

                            let data;
                            try {
                                const resp = await fetch(window.location.href, {
                                    method: 'POST',
                                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                    body: fd,
                                });
                                data = await resp.json();
                            } catch (err) {
                                overlay.style.display = 'none';
                                createBtn.disabled = false;
                                backBtn.style.pointerEvents = '';
                                backBtn.style.opacity = '';
                                alert('Network error: ' + err.message);
                                return;
                            }

                            if (!data.success) {
                                overlay.style.display = 'none';
                                createBtn.disabled = false;
                                backBtn.style.pointerEvents = '';
                                backBtn.style.opacity = '';
                                alert('Error creating claim: ' + (data.error || 'Unknown error'));
                                return;
                            }

                            // ── Sync results (instant) ──
                            const sync = data.sync_status || {};
                            setDone('db');
                            setSpinner('email');
                            setTimeout(() => {
                                if (sync.email) {
                                    setDone('email');
                                } else {
                                    setError('email', sync.email_error || 'Email send failed');
                                }
                            }, 400);

                            // ── Background task polling ──
                            const taskIds = data.task_ids || {};
                            const bgKeys = ['folder', 'templates', 'labels', 'encircle'];
                            const taskStatusUrl = '{% url "claim_task_status" %}';
                            const done = {};
                            let redirected = false;

                            // Start spinners for background tasks after a short delay
                            setTimeout(() => setSpinner('folder'), 600);
                            setTimeout(() => setSpinner('templates'), 800);
                            setTimeout(() => setSpinner('labels'), 1000);
                            setTimeout(() => setSpinner('encircle'), 1200);

                            function doRedirect(msg) {
                                if (redirected) return;
                                redirected = true;
                                statusP.textContent = msg;
                                setTimeout(() => { window.location.href = data.redirect_url; }, 1500);
                            }

                            function setRunningInBg(key) {
                                const el = getItem(key);
                                if (!el || done[key]) return;
                                // Replace spinner with a clock icon and note
                                el.querySelector('.task-icon').innerHTML =
                                    '<i class="fas fa-clock text-warning"></i>';
                                const errDiv = el.querySelector('.task-error');
                                errDiv.style.color = '#856404';
                                errDiv.textContent = 'Still running in background…';
                                errDiv.style.display = '';
                                done[key] = true;
                            }

                            function allBgDone() {
                                return bgKeys.every(k => done[k]);
                            }

                            // Hard timeout — redirect after 40s no matter what
                            const hardTimeout = setTimeout(() => {
                                bgKeys.forEach(k => setRunningInBg(k));
                                doRedirect('Claim saved! Slow tasks still running in background — opening claim…');
                            }, 40000);

                            async function pollTasks() {
                                if (redirected) return;
                                const remaining = bgKeys.filter(k => !done[k] && taskIds[k]);
                                if (!remaining.length) return;

                                const params = new URLSearchParams();
                                remaining.forEach(k => params.set(k, taskIds[k]));

                                try {
                                    const r = await fetch(taskStatusUrl + '?' + params.toString(), {
                                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                                    });
                                    const j = await r.json();
                                    const statuses = j.statuses || {};
                                    for (const key of remaining) {
                                        const s = statuses[key];
                                        if (!s) continue;
                                        if (s.state === 'SUCCESS') {
                                            setDone(key);
                                            done[key] = true;
                                        } else if (s.state === 'FAILURE') {
                                            setError(key, s.error);
                                            done[key] = true;
                                        }
                                        // PENDING / STARTED / RETRY → keep spinner, keep polling
                                    }
                                } catch (_) { /* network hiccup — keep polling */ }

                                if (allBgDone()) {
                                    clearTimeout(hardTimeout);
                                    const hasErrors = bgKeys.some(k => {
                                        const el = getItem(k);
                                        return el && el.querySelector('.task-error').style.display !== 'none';
                                    });
                                    if (hasErrors) {
                                        doRedirect('Some tasks had errors — opening claim page for details…');
                                    } else {
                                        doRedirect('All done! Opening claim…');
                                    }
                                } else {
                                    setTimeout(pollTasks, 3000);
                                }
                            }

                            // Mark any tasks with no task ID as skipped
                            bgKeys.forEach(k => { if (!taskIds[k]) done[k] = true; });

                            statusP.textContent = 'Waiting for background tasks…';
                            setTimeout(pollTasks, 2000);
                        });
                    })();
                    </script>

                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

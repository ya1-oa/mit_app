{% extends "account/base.html" %}
{% load static %}

{% block content %}
<style>
/* Base Styles */
body {
    background-color: #f0f2f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 100%;
    margin: 0;
    padding: 20px 40px;
    width: 100%;
}

h1, h2, h3, h4 {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-weight: 600;
}

/* Main Card Container - Full Width */
.main-card-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 30px;
    margin: 0 auto;
    width: calc(100% - 80px);
    max-width: none;
}

/* Card Grid Layout - Side by Side */
.card-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    margin-bottom: 30px;
    width: 100%;
}

.card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 25px;
    transition: all 0.3s ease;
    border-left: 4px solid #404040;
    flex: 1 1 calc(50% - 25px);
    min-width: 400px;
    box-sizing: border-box;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

/* Lease Type Card - Dark Background */
.card.lease-type {
    background-color: #404040;
    color: white;
}

.card.lease-type h3,
.card.lease-type p,
.card.lease-type strong {
    color: white;
}

.card.lease-type .form-control {
    background-color: #505050;
    border-color: #606060;
    color: white;
}

.card.lease-type .form-control:focus {
    border-color: #808080;
    box-shadow: 0 0 0 3px rgba(128,128,128,0.3);
}

/* Preview Thumbnail */
.preview-thumbnail {
    width: 100%;
    height: 200px;
    background: #f8fafc;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px dashed #d1d5db;
    transition: all 0.3s ease;
}

.preview-thumbnail:hover {
    background: #f0f4f8;
    border-color: #404040;
}

.preview-thumbnail i {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 60px;
}

.preview-thumbnail-text {
    font-size: 1.1rem;
    color: #6b7280;
    text-align: center;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1050;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 10px;
    border: 1px solid #888;
    width: 90%;
    max-width: 1200px;
    border-radius: 8px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 15px 0;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px 0;
    overflow-y: auto;
    flex-grow: 1;
}

.preview-modal-body {
    padding: 10px 0;
    overflow-y: hidden;
    flex-grow: 1;
}


.modal-iframe {
    width: 100%;
    height: 100%;
    min-height: 600px;
    border: none;
    border-radius: 4px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #404040;
}

/* Button Styles */
.action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    width: 100%;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    padding: 0.9rem 1.8rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    min-width: 180px;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.btn-primary {
    background-color: #404040;
    color: white;
}

.btn-primary:hover {
    background-color: #333;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid #404040;
    color: #404040;
}

.btn-outline:hover {
    background-color: #f5f5f5;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-control {
    width: 100%;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #404040;
    box-shadow: 0 0 0 3px rgba(64,64,64,0.1);
}

/* Client Details */
.client-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.client-details p {
    margin-bottom: 0.8rem;
    line-height: 1.6;
}

/* Responsive Adjustments */
@media (max-width: 1200px) {
    .container {
        padding: 20px;
    }
    
    .card {
        min-width: 300px;
    }
}

@media (max-width: 768px) {
    .card {
        flex: 1 1 100%;
    }
    
    .client-details {
        grid-template-columns: 1fr;
    }
}

/* Loading Spinner */
.spinner {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
    margin-right: 0.5rem;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

/* Document Type Badge */
.document-type-badge {
    display: inline-block;
    padding: 0.4rem 0.9rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 50px;
    background: #404040;
    color: white;
    margin-left: 12px;
    margin-bottom: 12px;
    margin-top: 12px;
    vertical-align: middle;
}
.oval {
    display: none; /* Ensures the oval wraps tightly around the text */
    padding: 10px 20px; /* Adjust padding for oval size */
    border: 2px solid #50C878; /* Border color and thickness */
    border-radius: 50px; /* Creates the oval shape */
    background-color: #D1FFDB; /* Optional: Background color */
    color: #198450; /* Text color */
    font-size: 16px; /* Adjust text size */
    text-align: center; /* Centers text inside the oval */
    }

    .download-button i {
        display: inline-flex;
        padding-right: 12px;
    }


</style>

<div class="container">
    <div class="main-card-container">
        <h1 style="font-size: 2rem; margin-bottom: 30px;">Document Generator</h1>
        
        <!-- Selection Row -->
        <div class="card-grid">
            <form method="get" id="combined-form" class="mb-4">
                <!-- Document Selection -->
                <div class="form-group">
                    <label for="document_id">Select Document Type:</label>
                    <select name="document_name" id="document_id" class="form-control">
                        <option value="">-- Select a Document --</option>
                        {% for document in documents %}
                            <option value="{{ document.name }}"
                                    {% if document.name == selected_document %}selected{% endif %}>
                                {{ document.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
    
                <!-- Client Selection -->
                <div class="form-group">
                    <label for="client_id">Select Claim by Customer Name:</label>
                    <select name="client_name" id="client_id" class="form-control">
                        <option value="">-- Select a Claim --</option>
                        {% for client in clients %}
                            <option value="{{ client.pOwner }}" 
                                    {% if client.pOwner == selected_client_id %}selected{% endif %}>
                                        {{ client.pOwner }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {% if selected_client and selected_document %}
        <!-- Details Row -->
        <div class="card-grid">
            <!-- Client Details -->
            <div class="card">
                <h3>Claim Details</h3>
                <div class="client-details">
                    <div>
                        <h4>Customer Information</h4>
                        <p><strong>Owner:</strong> {{ selected_client.pOwner }}</p>
                        <p><strong>Address:</strong> {{ selected_client.pAddress }}</p>
                        <p><strong>City/State/Zip:</strong> {{ selected_client.pCityStateZip }}</p>
                        <p><strong>Phone:</strong> {{ selected_client.cPhone }}</p>
                        <p><strong>Email:</strong> {{ selected_client.cEmail }}</p>
                    </div>
                    <div>
                        <h4>Claim Information</h4>
                        <p><strong>Claim #:</strong> {{ selected_client.claimNumber }}</p>
                        <p><strong>Policy #:</strong> {{ selected_client.policyNumber }}</p>
                        <p><strong>Date of Loss:</strong> {{ selected_client.dateOfLoss|date:"Y-m-d" }}</p>
                        <p><strong>Cause of Loss:</strong> {{ selected_client.causeOfLoss }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Document Details -->
            <div class="card">
                <h3>Document Details</h3>
                <p><strong>Document Name:</strong> {{ selected_document.name }}</p>
                <p><strong>Type:</strong> <span class="document-type-badge">{{ selected_document.document_type|upper }}</span></p>
                
                <!-- Preview Thumbnail -->
                <div class="preview-thumbnail" id="previewThumbnail">
                    <i class="fa fa-file-text-o"></i>
                    <div class="preview-thumbnail-text">Click to preview document</div>
                </div>
            </div>
            

            <!-- Landlord Form (if applicable) -->
            {% if selected_document.document_type == 'lease' %}
            <!-- Landlord Form Modal -->
            <div id="landlordModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Landlord Information</h3>
                        <span class="close">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="landlord-form-container">
                            <form id="landlord-form">
                                {% csrf_token %}
                                {{ form.as_p }}
                                <div class="form-group" style="margin-top: 30px;">
                                    <button type="button" id="saveLandlordInfo" class="btn btn-primary">
                                        Save Information
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <!-- Landlord activate modal button -->
            <p class="oval" id="landlordFormStatus"></p>

            <button type="button" id="landlordFormButton" class="btn btn-primary">
                    Landlord Info Form
            </button>

            <button id="previewButton" class="btn btn-primary">
                <span class="spinner" id="previewSpinner" style="display:none;"></span>
                Generate Preview
            </button>
            <button class="download-button" id="downloadButton" class="btn btn-outline" style="display:none;">
                <i class="fa fa-download" style="margin-right: 8px;"></i>
                Download PDF
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Document Preview: {{ selected_document.name }}</h3>
            <span class="close">&times;</span>
        </div>
        <div class="preview-modal-body">
            <iframe id="documentPreview" class="modal-iframe" style="display:none;"></iframe>
            <div id="modalLoading" style="text-align:center; padding:50px;">
                <div class="spinner" style="width:3rem;height:3rem;"></div>
                <p>Loading document preview...</p>
            </div>
        </div>
    </div>
</div>

<!-- PDF Generation Form (hidden) -->
<form id="pdf-generation-form" action="{% url 'generate_pdf' %}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="document_name" value="{{ selected_document.name }}">
    <input type="hidden" name="client_name" value="{{ selected_client.pOwner }}">
    <input type="hidden" name="document_type" value="{{ selected_document.document_type }}">
    
    {% for field in form %}
        <input type="hidden" id="hidden_{{ field.name }}" name="{{ field.name }}">
    {% endfor %}
</form>

<script>


document.addEventListener('DOMContentLoaded', function() {
    // Clear form fields if they exist
    let currentClient = localStorage.getItem('selectedClient');
    
    function clearLandlordForm() {
        const landlordForm = document.getElementById('landlord-form');
        if (landlordForm) {
            const inputs = landlordForm.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type !== 'hidden' && input.type !== 'submit' && input.type !== 'button') {
                    input.value = '';
                    // Reset any validation classes
                    input.classList.remove('is-invalid');
                }
            });
            // Clear any saved status
            const landlordFormStatus = document.getElementById('landlordFormStatus');
            if (landlordFormStatus) {
                landlordFormStatus.style.display = 'none';
                landlordFormStatus.textContent = '';
            }
        }
    }

    function handleClientChange() {
        const newClient = clientSelect.value;
        
        // Only clear if the client has actually changed
        if (newClient && newClient !== currentClient) {
            clearLandlordForm();
            currentClient = newClient;
        }
        
        localStorage.setItem('selectedClient', newClient);
        if (documentSelect.value && newClient) {
            document.getElementById('combined-form').submit();
        }
    }

    // DOM Elements
    const documentSelect = document.getElementById('document_id');
    const clientSelect = document.getElementById('client_id');

        // Restore selections
    const savedDocument = localStorage.getItem('selectedDocument');
    const savedClient = localStorage.getItem('selectedClient');
    if (savedDocument) documentSelect.value = savedDocument;
    if (savedClient) clientSelect.value = savedClient;

    
    // Form Selections
    function saveSelections() {
        console.log("Event handler for change on form fired!")
        localStorage.setItem('selectedDocument', documentSelect.value);
        localStorage.setItem('selectedClient', clientSelect.value);
        if (documentSelect.value && clientSelect.value) {
            document.getElementById('combined-form').submit();
        }
    }
    
    documentSelect.addEventListener('change', saveSelections);
    clientSelect.addEventListener('change', handleClientChange);

    const previewButton = document.getElementById('previewButton');
    const downloadButton = document.getElementById('downloadButton');
    const previewThumbnail = document.getElementById('previewThumbnail');
    const previewModal = document.getElementById('previewModal');
    const modalIframe = document.getElementById('documentPreview');
    const closeModal = document.querySelector('.close');
    const previewSpinner = document.getElementById('previewSpinner');
    const modalLoading = document.getElementById('modalLoading');

    // Landlord Form Modal Handling
    const landlordModal = document.getElementById('landlordModal');
    const landlordFormButton = document.getElementById('landlordFormButton');
    const saveLandlordInfo = document.getElementById('saveLandlordInfo');
    const landlordFormStatus = document.getElementById('landlordFormStatus');
    const closeButtons = document.querySelectorAll('.close');
    
    if (landlordFormButton) {
        landlordFormButton.addEventListener('click', function() {
            landlordModal.style.display = 'block';
        });
    }
    

    // Close modal when clicking X
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            landlordModal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === landlordModal) {
            landlordModal.style.display = 'none';
        }
    });
    
    if (saveLandlordInfo) {
        saveLandlordInfo.addEventListener('click', function() {
            const landlordForm = document.getElementById('landlord-form');
            const formData = new FormData(landlordForm);
        
        // Add CSRF token
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // AJAX save to database
        fetch("{% url 'save_landlord' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                landlordFormStatus.style.display = 'inline-block';
                landlordFormStatus.textContent = "Landlord information saved";
                landlordFormStatus.style.color = "#4CAF50";
                landlordModal.style.display = 'none';
                
                // Store form data in hidden fields for PDF generation
                const pdfForm = document.getElementById('pdf-generation-form');
                const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
                
                landlordInputs.forEach(input => {
                    if (input.name && input.type !== 'file') {
                        const hiddenField = pdfForm.querySelector(`#hidden_${input.name}`);
                        if (hiddenField) hiddenField.value = input.value;
                    }
                });
            } else {
                alert('Error saving landlord: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving landlord information');
        });
      });
    };

    // Modal Controls
    previewThumbnail.addEventListener('click', function() {
        if (modalIframe.style.display === 'block') {
            previewModal.style.display = 'block';
        }
    });

    // Close modal when clicking X
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            previewModal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === previewModal) {
            previewModal.style.display = 'none';
        }
    });




    // Preview Button
    previewButton.addEventListener('click', function() {
        previewSpinner.style.display = 'inline-block';
        previewButton.disabled = true;
        
        // Validate form if lease document
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            if (landlordForm) {
                const requiredFields = landlordForm.querySelectorAll('[required]');
                let allValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.classList.add('is-invalid');
                    }
                });
                
                if (!allValid) {
                    alert('Please fill in all required fields');
                    previewSpinner.style.display = 'none';
                    previewButton.disabled = false;
                    return;
                }
            }
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('client_name', "{{ selected_client.pOwner }}");
        formData.append('document_name', "{{ selected_document.name }}");
        formData.append('document_type', "{{ selected_document.document_type }}");
        formData.append('preview', 'true');
        
        // Add landlord data if applicable
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
            
            landlordInputs.forEach(input => {
                if (input.name && input.type !== 'file') {
                    formData.append(input.name, input.value);
                }
            });
        }
        
        // AJAX request
        fetch("{% url 'generate_pdf' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            modalIframe.srcdoc = html;
            modalIframe.style.display = 'block';
            modalLoading.style.display = 'none';
            downloadButton.style.display = 'inline-flex';
            previewThumbnail.innerHTML = `
                <i class="fa fa-check-circle" style="color:#4CAF50;font-size:3rem;"></i>
                <div class="preview-thumbnail-text">Preview generated - Click to view</div>
            `;
            previewModal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            previewThumbnail.innerHTML = `
                <i class="fa fa-exclamation-triangle" style="color:#F44336;font-size:3rem;"></i>
                <div class="preview-thumbnail-text">Preview failed - Click to retry</div>
            `;
        })
        .finally(() => {
            previewSpinner.style.display = 'none';
            previewButton.disabled = false;
        });
    });

    // Download Button
    downloadButton.addEventListener('click', function() {
        const pdfForm = document.getElementById('pdf-generation-form');
        pdfForm.querySelector('[name=document_name]').value = "{{ selected_document.name }}";
        pdfForm.querySelector('[name=client_name]').value = "{{ selected_client.pOwner }}";
        pdfForm.querySelector('[name=document_type]').value = "{{ selected_document.document_type }}";
        
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
            
            landlordInputs.forEach(input => {
                if (input.name && input.type !== 'file') {
                    const hiddenField = pdfForm.querySelector(`#hidden_${input.name}`);
                    if (hiddenField) hiddenField.value = input.value;
                }
            });
        }
        
        pdfForm.submit();
    });
});
</script>
{% endblock %}

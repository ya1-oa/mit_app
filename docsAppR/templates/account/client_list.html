{% extends "account/base.html" %}
{% load static %}

{% block content %}
<style>
/* Base Styles */
body {
    background-color: #f0f2f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.container {
    max-width: 100%;
    margin: 0;
    padding: 20px 40px;
    width: 100%;
}

h1, h2, h3, h4 {
    color: #2c3e50;
    margin-bottom: 1.5rem;
    font-weight: 600;
}

/* Main Card Container - Full Width */
.main-card-container {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 30px;
    margin: 0 auto;
    width: calc(100% - 80px);
    max-width: none;
}

/* Card Grid Layout - Side by Side */
.card-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    margin-bottom: 30px;
    width: 100%;
}

.card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 25px;
    transition: all 0.3s ease;
    border-left: 4px solid #404040;
    flex: 1 1 calc(50% - 25px);
    min-width: 400px;
    box-sizing: border-box;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

/* Lease Type Card - Dark Background */
.card.lease-type {
    background-color: #404040;
    color: white;
}

.card.lease-type h3,
.card.lease-type p,
.card.lease-type strong {
    color: white;
}

.card.lease-type .form-control {
    background-color: #505050;
    border-color: #606060;
    color: white;
}

.card.lease-type .form-control:focus {
    border-color: #808080;
    box-shadow: 0 0 0 3px rgba(128,128,128,0.3);
}

/* Preview Thumbnail */
.preview-thumbnail {
    width: 100%;
    height: 200px;
    background: #f8fafc;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1px dashed #d1d5db;
    transition: all 0.3s ease;
}

.preview-thumbnail:hover {
    background: #f0f4f8;
    border-color: #404040;
}

.preview-thumbnail i {
    font-size: 3rem;
    color: #9ca3af;
    margin-bottom: 60px;
}

.preview-thumbnail-text {
    font-size: 1.1rem;
    color: #6b7280;
    text-align: center;
}

/* Modal Styles */
 /* Preview Modal Styling */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 1200px;
        height: 90vh;
        display: flex;
        flex-direction: column;
    }


.modal-header {
    padding: 10px 0;
    border-bottom: 1px solid #ddd;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
    .preview-modal-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-iframe {
        flex: 1;
        width: 100%;
        border: none;
        background: white;
        overflow-y: auto;
    }

    /* Disable body scroll when modal is open */
    body.modal-open {
        overflow: hidden;
    }


.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    margin-left: auto; /* This pushes it to the right */
    padding: 0 10px;
}

.close:hover {
    color: #404040;
}
/* Button Styles */
.action-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    width: 100%;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    padding: 0.9rem 1.8rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    min-width: 180px;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.btn-primary {
    background-color: #404040;
    color: white;
}

.btn-primary:hover {
    background-color: #333;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.btn-outline {
    background-color: transparent;
    border: 1px solid #404040;
    color: #404040;
}

.btn-outline:hover {
    background-color: #f5f5f5;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-control {
    width: 100%;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #404040;
    box-shadow: 0 0 0 3px rgba(64,64,64,0.1);
}

/* Client Details */
.client-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.client-details p {
    margin-bottom: 0.8rem;
    line-height: 1.6;
}

/* Responsive Adjustments */
@media (max-width: 1200px) {
    .container {
        padding: 20px;
    }
    
    .card {
        min-width: 300px;
    }
}

@media (max-width: 768px) {
    .card {
        flex: 1 1 100%;
    }
    
    .client-details {
        grid-template-columns: 1fr;
    }
}

/* Loading Spinner */
.spinner {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
    margin-right: 0.5rem;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

/* Document Type Badge */
.document-type-badge {
    display: inline-block;
    padding: 0.4rem 0.9rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 50px;
    background: #404040;
    color: white;
    margin-left: 12px;
    margin-bottom: 12px;
    margin-top: 12px;
    vertical-align: middle;
}
.oval {
    display: none; /* Ensures the oval wraps tightly around the text */
    padding: 10px 20px; /* Adjust padding for oval size */
    border: 2px solid #50C878; /* Border color and thickness */
    border-radius: 50px; /* Creates the oval shape */
    background-color: #D1FFDB; /* Optional: Background color */
    color: #198450; /* Text color */
    font-size: 16px; /* Adjust text size */
    text-align: center; /* Centers text inside the oval */
    }

    .download-button i {
        display: inline-flex;
        padding-right: 12px;
    }

     .form-tabs {
        display: flex;
        padding: 0 15px;
    }
    
    .tab-button {
        padding: 8px 15px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        color: #404040;
    }
    
    .tab-button.active {
        color: #404040;
        border-bottom-color: #404040;
    }
    
    .tab-content {
        display: none;
        flex: 1;
        overflow-y: auto;
        padding: 0 15px;
    }
    
    .tab-content.active {
        display: block;
    }

    /* Form field styling */
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: inherit;
    }
    
    /* Specifically style textareas to match other inputs */
    textarea.form-control {
        resize: vertical; /* Allow vertical resize only */
        min-height: 38px; /* Match input field height */
        max-height: 120px; /* Limit maximum expansion */
        line-height: 1.5;
        overflow: auto; /* Hide the resize handle in some browsers */
    }
    
    /* Remove the resize handle in Firefox */
    textarea.form-control::-webkit-resizer {
        display: none;
    }
    
    /* Style select elements to match */
    select.form-control {
        height: 38px;
        background-color: white;
    }
</style>

<div class="container">
    <div class="main-card-container">
        <h1 style="font-size: 2rem; margin-bottom: 30px;">Document Generator</h1>
        
        <!-- Selection Row -->
        <div class="card-grid">
            <form method="get" id="combined-form" class="mb-4">
                <!-- Document Selection -->
                <div class="form-group">
                    <label for="document_id">Select Document Type:</label>
                    <select name="document_name" id="document_id" class="form-control">
                        <option value="">-- Select a Document --</option>
                        {% for document in documents %}
                            <option value="{{ document.name }}"
                                    {% if document.name == selected_document %}selected{% endif %}>
                                {{ document.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
    
                <!-- Client Selection -->
                <div class="form-group">
                    <label for="client_id">Select Claim by Customer Name:</label>
                    <select name="client_name" id="client_id" class="form-control">
                        <option value="">-- Select a Claim --</option>
                        {% for client in clients %}
                            <option value="{{ client.pOwner }}" 
                                    {% if client.pOwner == selected_client_id %}selected{% endif %}>
                                        {{ client.pOwner }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {% if selected_client and selected_document %}
        <!-- Details Row -->
        <div class="card-grid">
            <!-- Client Details -->
            <div class="card">
                <h3>Claim Details</h3>
                <div class="client-details">
                    <div>
                        <h4>Customer Information</h4>
                        <p><strong>Owner:</strong> {{ selected_client.pOwner }}</p>
                        <p><strong>Address:</strong> {{ selected_client.pAddress }}</p>
                        <p><strong>City/State/Zip:</strong> {{ selected_client.pCityStateZip }}</p>
                        <p><strong>Phone:</strong> {{ selected_client.cPhone }}</p>
                        <p><strong>Email:</strong> {{ selected_client.cEmail }}</p>
                    </div>
                    <div>
                        <h4>Claim Information</h4>
                        <p><strong>Claim #:</strong> {{ selected_client.claimNumber }}</p>
                        <p><strong>Policy #:</strong> {{ selected_client.policyNumber }}</p>
                        <p><strong>Date of Loss:</strong> {{ selected_client.dateOfLoss|date:"Y-m-d" }}</p>
                        <p><strong>Cause of Loss:</strong> {{ selected_client.causeOfLoss }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Document Details -->
            <div class="card">
                <h3>Document Details</h3>
                <p><strong>Document Name:</strong> {{ selected_document.name }}</p>
                <p><strong>Type:</strong> <span class="document-type-badge">{{ selected_document.document_type|upper }}</span></p>
                
                <!-- Preview Thumbnail -->
                <div class="preview-thumbnail" id="previewThumbnail">
                    <i class="fa fa-file-text-o"></i>
                    <div class="preview-thumbnail-text">Click to preview document</div>
                </div>
            </div>
            

<!-- Landlord Form Modal -->
<!-- Landlord Form Modal -->
{% if selected_document.document_type == 'lease' %}
<div id="landlordModal" class="modal">
    <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh;">
        <div class="modal-header">
            <h3>Landlord Information</h3>
            <span class="close">&times;</span>
        </div>
        
        <!-- Tab Navigation -->
        <div class="form-tabs" style="border-bottom: 1px solid #ddd; margin-bottom: 15px;">
            <button class="tab-button active" data-tab="basic-info">Basic Info</button>
            <button class="tab-button" data-tab="property-info">Property Info</button>
            <button class="tab-button" data-tab="rental-terms">Rental Terms</button>
            <button class="tab-button" data-tab="company-info">Company Info</button>
        </div>
        
        <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
            <form id="landlord-form" autocomplete="on" style="display: flex; flex-direction: column; height: 100%;">
                {% csrf_token %}
                
                <!-- Basic Information Tab -->
                <div class="tab-content active" id="basic-info-tab">
                    <div class="form-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="{{ form.full_name.id_for_label }}">{{ form.full_name.label }}</label>
                            {{ form.full_name }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.phone.id_for_label }}">{{ form.phone.label }}</label>
                            {{ form.phone }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.address.id_for_label }}">{{ form.address.label }}</label>
                            {{ form.address }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                            {{ form.email }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.city.id_for_label }}">{{ form.city.label }}</label>
                            {{ form.city }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.state.id_for_label }}">{{ form.state.label }}</label>
                            {{ form.state }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.zip_code.id_for_label }}">{{ form.zip_code.label }}</label>
                            {{ form.zip_code }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.contact_person_1.id_for_label }}">{{ form.contact_person_1.label }}</label>
                            {{ form.contact_person_1 }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.contact_person_2.id_for_label }}">{{ form.contact_person_2.label }}</label>
                            {{ form.contact_person_2 }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.contact_phone.id_for_label }}">{{ form.contact_phone.label }}</label>
                            {{ form.contact_phone }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.contact_email.id_for_label }}">{{ form.contact_email.label }}</label>
                            {{ form.contact_email }}
                        </div>
                    </div>
                </div>
                
                <!-- Property Information Tab -->
                <div class="tab-content" id="property-info-tab">
                    <div class="form-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="{{ form.property_address.id_for_label }}">{{ form.property_address.label }}</label>
                            {{ form.property_address }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.property_city.id_for_label }}">{{ form.property_city.label }}</label>
                            {{ form.property_city }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.property_state.id_for_label }}">{{ form.property_state.label }}</label>
                            {{ form.property_state }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.property_zip.id_for_label }}">{{ form.property_zip.label }}</label>
                            {{ form.property_zip }}
                        </div>

                    </div>
                </div>
                
                <!-- Rental Terms Tab -->
                <div class="tab-content" id="rental-terms-tab">
                    <div class="form-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="{{ form.default_rent_amount.id_for_label }}">{{ form.default_rent_amount.label }}</label>
                            {{ form.default_rent_amount }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_security_deposit.id_for_label }}">{{ form.default_security_deposit.label }}</label>
                            {{ form.default_security_deposit }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_rent_due_day.id_for_label }}">{{ form.default_rent_due_day.label }}</label>
                            {{ form.default_rent_due_day }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_late_fee.id_for_label }}">{{ form.default_late_fee.label }}</label>
                            {{ form.default_late_fee }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_late_fee_start_day.id_for_label }}">{{ form.default_late_fee_start_day.label }}</label>
                            {{ form.default_late_fee_start_day }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_eviction_day.id_for_label }}">{{ form.default_eviction_day.label }}</label>
                            {{ form.default_eviction_day }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_nsf_fee.id_for_label }}">{{ form.default_nsf_fee.label }}</label>
                            {{ form.default_nsf_fee }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_max_occupants.id_for_label }}">{{ form.default_max_occupants.label }}</label>
                            {{ form.default_max_occupants }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_parking_spaces.id_for_label }}">{{ form.default_parking_spaces.label }}</label>
                            {{ form.default_parking_spaces }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_parking_fee.id_for_label }}">{{ form.default_parking_fee.label }}</label>
                            {{ form.default_parking_fee }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.default_inspection_fee.id_for_label }}">{{ form.default_inspection_fee.label }}</label>
                            {{ form.default_inspection_fee }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.bedrooms.id_for_label }}">{{ form.bedrooms.label }}</label>
                            {{ form.bedrooms }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.rental_months.id_for_label }}">{{ form.rental_months.label }}</label>
                            {{ form.rental_months }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.term_start_date.id_for_label }}">{{ form.term_start_date.label }}</label>
                            {{ form.term_start_date }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.term_end_date.id_for_label }}">{{ form.term_end_date.label }}</label>
                            {{ form.term_end_date }}
                        </div>
                    </div>
                </div>
                
                <!-- Company Information Tab -->
                <div class="tab-content" id="company-info-tab">
                    <div class="form-fields-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="{{ form.real_estate_company.id_for_label }}">{{ form.real_estate_company.label }}</label>
                            {{ form.real_estate_company }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_mailing_address.id_for_label }}">{{ form.company_mailing_address.label }}</label>
                            <textarea id="{{ form.company_mailing_address.id_for_label }}" 
                                      name="{{ form.company_mailing_address.name }}" 
                                      class="form-control" 
                                      rows="2">{{ form.company_mailing_address.value|default_if_none:'' }}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_city.id_for_label }}">{{ form.company_city.label }}</label>
                            {{ form.company_city }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_state.id_for_label }}">{{ form.company_state.label }}</label>
                            {{ form.company_state }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_zip.id_for_label }}">{{ form.company_zip.label }}</label>
                            {{ form.company_zip }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_contact_person.id_for_label }}">{{ form.company_contact_person.label }}</label>
                            {{ form.company_contact_person }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_phone.id_for_label }}">{{ form.company_phone.label }}</label>
                            {{ form.company_phone }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.company_email.id_for_label }}">{{ form.company_email.label }}</label>
                            {{ form.company_email }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.broker_name.id_for_label }}">{{ form.broker_name.label }}</label>
                            {{ form.broker_name }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.broker_phone.id_for_label }}">{{ form.broker_phone.label }}</label>
                            {{ form.broker_phone }}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.broker_email.id_for_label }}">{{ form.broker_email.label }}</label>
                            {{ form.broker_email }}
                        </div>
                    </div>
                </div>
                
                <div class="form-actions" style="padding: 15px 0; border-top: 1px solid #eee; margin-top: auto;">
                    <button type="button" id="saveLandlordInfo" class="btn btn-primary" style="width: 100%; max-width: 200px; margin: 0 auto;">
                        Save Information
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <!-- Landlord activate modal button -->
            <p class="oval" id="landlordFormStatus"></p>

            <button type="button" id="landlordFormButton" class="btn btn-primary">
                    Lessor Info Form
            </button>

            <button id="previewButton" class="btn btn-primary">
                <span class="spinner" id="previewSpinner" style="display:none;"></span>
                Generate Preview
            </button>
            <button class="download-button" id="downloadButton" class="btn btn-outline" style="display:none;">
                <i class="fa fa-download" style="margin-right: 8px;"></i>
                Download PDF
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content" style="display: flex; flex-direction: column; max-height: 90vh;">
        <div class="modal-header">
            <h3>Document Preview: {{ selected_document.name }}</h3>
            <span class="close">&times;</span>
        </div>
        <div class="preview-modal-body" style="flex: 1; overflow: hidden; position: relative;">
            <iframe id="documentPreview" class="modal-iframe" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"></iframe>
            <div id="modalLoading" style="text-align: center; padding: 50px;">
                <div class="spinner" style="width: 3rem; height: 3rem;"></div>
                <p>Loading document preview...</p>
            </div>
        </div>
    </div>
</div>


<!-- PDF Generation Form (hidden) -->
<form id="pdf-generation-form" action="{% url 'generate_pdf' %}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="document_name" value="{{ selected_document.name }}">
    <input type="hidden" name="client_name" value="{{ selected_client.pOwner }}">
    <input type="hidden" name="document_type" value="{{ selected_document.document_type }}">
    
    {% for field in form %}
        <input type="hidden" id="hidden_{{ field.name }}" name="{{ field.name }}">
    {% endfor %}
</form>

<script>


document.addEventListener('DOMContentLoaded', function() {
    // Clear form fields if they exist
    const currentClaimId = "{{ current_client_id }}";
    let previousClaimId = localStorage.getItem('lastClaimId');
    
    // Function to save form data to sessionStorage
    function saveLandlordFormData() {
        const form = document.getElementById('landlord-form');
        if (!form) return;
        
        const formData = {};
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            if (input.name && input.type !== 'file') {
                formData[input.name] = input.value;
            }
        });
        
        sessionStorage.setItem(`landlordForm_${previousClaimId}`, JSON.stringify(formData));
    }
    
    // Function to restore form data from sessionStorage
    function restoreLandlordFormData() {
        // Only restore if we're still on the same claim
        if (currentClaimId && currentClaimId === previousClaimId) {
            const form = document.getElementById('landlord-form');
            if (!form) return;
            
            const savedData = sessionStorage.getItem(`landlordForm_${currentClaimId}`);
            if (!savedData) return;
            
            const formData = JSON.parse(savedData);
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.name && input.type !== 'file' && formData[input.name] !== undefined) {
                    input.value = formData[input.name];
                }
            });
        }
    }
    
    // Clear form data when claim changes
    function handleClaimChange() {
        if (currentClaimId && currentClaimId !== previousClaimId) {
            sessionStorage.removeItem(`landlordForm_${previousClaimId}`);
            localStorage.setItem('lastClaimId', currentClaimId);
        }
    }
    
    // Initialize
    handleClaimChange(); // Check if claim changed
    restoreLandlordFormData(); // Restore if same claim
    
    // Document selection handler - preserve form data
    function handleDocumentChange() {
        saveLandlordFormData(); // Save before submitting
        localStorage.setItem('selectedDocument', documentSelect.value);
        localStorage.setItem('selectedClient', clientSelect.value);
        if (documentSelect.value && clientSelect.value) {
            document.getElementById('combined-form').submit();
        }
    }
    
    // Client selection handler - clear form data
    function handleClientChange() {
        // Clear the saved form data for the previous claim
        if (previousClaimId) {
            sessionStorage.removeItem(`landlordForm_${previousClaimId}`);
        }
        localStorage.setItem('selectedDocument', documentSelect.value);
        localStorage.setItem('selectedClient', clientSelect.value);
        localStorage.setItem('lastClaimId', clientSelect.value);
        if (documentSelect.value && clientSelect.value) {
            document.getElementById('combined-form').submit();
        }
    }
    
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Show corresponding content
                const tabId = this.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });

    // DOM Elements
    const documentSelect = document.getElementById('document_id');
    const clientSelect = document.getElementById('client_id');

        // Restore selections
    const savedDocument = localStorage.getItem('selectedDocument');
    const savedClient = localStorage.getItem('selectedClient');
    if (savedDocument) documentSelect.value = savedDocument;
    if (savedClient) clientSelect.value = savedClient;

    
    documentSelect.addEventListener('change', handleDocumentChange);
    clientSelect.addEventListener('change', handleClientChange);

    const previewButton = document.getElementById('previewButton');
    const downloadButton = document.getElementById('downloadButton');
    const previewThumbnail = document.getElementById('previewThumbnail');
    const previewModal = document.getElementById('previewModal');
    const modalIframe = document.getElementById('documentPreview');
    const closeModal = document.querySelector('.close');
    const previewSpinner = document.getElementById('previewSpinner');
    const modalLoading = document.getElementById('modalLoading');

    // Landlord Form Modal Handling
    const landlordModal = document.getElementById('landlordModal');
    const landlordFormButton = document.getElementById('landlordFormButton');
    const saveLandlordInfo = document.getElementById('saveLandlordInfo');
    const landlordFormStatus = document.getElementById('landlordFormStatus');
    const closeButtons = document.querySelectorAll('.close');
    
    if (landlordFormButton) {
        landlordFormButton.addEventListener('click', function() {
            landlordModal.style.display = 'block';
        });
    }
    

    // Close modal when clicking X
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            landlordModal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === landlordModal) {
            landlordModal.style.display = 'none';
        }
    });
    
    if (saveLandlordInfo) {
        saveLandlordInfo.addEventListener('click', function() {
            const landlordForm = document.getElementById('landlord-form');
            const formData = new FormData(landlordForm);
        
        // Add CSRF token
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // AJAX save to database
        fetch("{% url 'save_landlord' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                landlordFormStatus.style.display = 'inline-block';
                landlordFormStatus.textContent = "Landlord information saved";
                landlordFormStatus.style.color = "#4CAF50";
                landlordModal.style.display = 'none';
                
                // Store form data in hidden fields for PDF generation
                const pdfForm = document.getElementById('pdf-generation-form');
                const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
                
                landlordInputs.forEach(input => {
                    if (input.name && input.type !== 'file') {
                        const hiddenField = pdfForm.querySelector(`#hidden_${input.name}`);
                        if (hiddenField) hiddenField.value = input.value;
                    }
                });
            } else {
                alert('Error saving landlord: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving landlord information');
        });
      });
    };

   function openPreviewModal() {
    document.body.classList.add('modal-open');
    previewModal.style.display = 'block';
    
    // Force redraw to ensure proper rendering
    setTimeout(() => {
        modalIframe.style.height = '100%';
        // Focus the iframe to ensure keyboard scrolling works
        if (modalIframe.contentWindow) {
            modalIframe.contentWindow.focus();
        }
    }, 50);
}

function closePreviewModal() {
    document.body.classList.remove('modal-open');
    previewModal.style.display = 'none';
}

// Thumbnail click handler
previewThumbnail.addEventListener('click', function() {
    if (modalIframe.style.display === 'block') {
        openPreviewModal();
    }
});

// Close modal handlers
closeButtons.forEach(button => {
    button.addEventListener('click', closePreviewModal);
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    if (event.target === previewModal) {
        closePreviewModal();
    }
});

// Ensure iframe content can be scrolled
window.addEventListener('keydown', function(event) {
    if (previewModal.style.display === 'block') {
        // Allow arrow keys and page up/down to scroll the iframe
        const iframeWindow = modalIframe.contentWindow;
        if (iframeWindow) {
            iframeWindow.dispatchEvent(new KeyboardEvent('keydown', event));
        }
    }
});

    // Preview Button
    previewButton.addEventListener('click', function() {
       openPreviewModal();
        previewButton.disabled = true;
        
        // Validate form if lease document
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            if (landlordForm) {
                const requiredFields = landlordForm.querySelectorAll('[required]');
                let allValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        allValid = false;
                        field.classList.add('is-invalid');
                    }
                });
                
                if (!allValid) {
                    alert('Please fill in all required fields');
                    previewSpinner.style.display = 'none';
                    previewButton.disabled = false;
                    return;
                }
            }
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('client_name', "{{ selected_client.pOwner }}");
        formData.append('document_name', "{{ selected_document.name }}");
        formData.append('document_type', "{{ selected_document.document_type }}");
        formData.append('preview', 'true');
        
        // Add landlord data if applicable
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
            
            landlordInputs.forEach(input => {
                if (input.name && input.type !== 'file') {
                    formData.append(input.name, input.value);
                }
            });
        }
        
        // AJAX request
        fetch("{% url 'generate_pdf' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            modalIframe.srcdoc = html;
            modalIframe.style.display = 'block';
            modalLoading.style.display = 'none';
            downloadButton.style.display = 'inline-flex';
            previewThumbnail.innerHTML = `
                <i class="fa fa-check-circle" style="color:#4CAF50;font-size:3rem;"></i>
                <div class="preview-thumbnail-text">Preview generated - Click to view</div>
            `;
            previewModal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            previewThumbnail.innerHTML = `
                <i class="fa fa-exclamation-triangle" style="color:#F44336;font-size:3rem;"></i>
                <div class="preview-thumbnail-text">Preview failed - Click to retry</div>
            `;
        })
        .finally(() => {
            previewSpinner.style.display = 'none';
            previewButton.disabled = false;
        });
    });

    // Download Button
    downloadButton.addEventListener('click', function() {
        const pdfForm = document.getElementById('pdf-generation-form');
        pdfForm.querySelector('[name=document_name]').value = "{{ selected_document.name }}";
        pdfForm.querySelector('[name=client_name]').value = "{{ selected_client.pOwner }}";
        pdfForm.querySelector('[name=document_type]').value = "{{ selected_document.document_type }}";
        
        if ("{{ selected_document.document_type }}" === 'lease') {
            const landlordForm = document.getElementById('landlord-form');
            const landlordInputs = landlordForm.querySelectorAll('input, select, textarea');
            
            landlordInputs.forEach(input => {
                if (input.name && input.type !== 'file') {
                    const hiddenField = pdfForm.querySelector(`#hidden_${input.name}`);
                    if (hiddenField) hiddenField.value = input.value;
                }
            });
        }
        
        pdfForm.submit();
    });
});
</script>
{% endblock %}
{% extends "account/base.html" %}
{% load static %}

{% block title %}Lease Manager{% endblock %}
{% block page_title %}<i class="fas fa-file-contract"></i> ALE Lease Manager{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard Stats Cards */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #404040;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.12);
    }

    .stat-card.primary { border-left-color: #0066cc; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.danger { border-left-color: #dc3545; }
    .stat-card.info { border-left-color: #17a2b8; }

    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #333;
    }

    .stat-card p {
        margin: 5px 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    /* Main Content Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 25px;
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Pipeline Section */
    .pipeline-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

    .pipeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .pipeline-header h2 {
        margin: 0;
        font-size: 1.25rem;
        color: #333;
    }

    .pipeline-stages {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .pipeline-stage {
        flex: 1;
        min-width: 90px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }

    .pipeline-stage:hover {
        background: #e9ecef;
    }

    .pipeline-stage.active {
        border-color: #404040;
        background: #fff;
    }

    .pipeline-stage .count {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
    }

    .pipeline-stage .label {
        font-size: 0.7rem;
        color: #666;
        margin-top: 5px;
    }

    /* Tabs */
    .tab-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .tab-nav {
        display: flex;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
    }

    .tab-btn {
        flex: 1;
        padding: 15px 20px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }

    .tab-btn:hover {
        background: #e9ecef;
        color: #333;
    }

    .tab-btn.active {
        background: white;
        color: #404040;
        border-bottom-color: #404040;
    }

    .tab-content {
        display: none;
        padding: 20px;
    }

    .tab-content.active {
        display: block;
    }

    /* Lease Cards */
    .lease-card {
        border: 1px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 15px;
        overflow: hidden;
        background: white;
    }

    .lease-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 15px 20px;
        background: #f8f9fa;
        cursor: pointer;
        transition: background 0.2s;
    }

    .lease-card-header:hover {
        background: #e9ecef;
    }

    .lease-info h4 {
        margin: 0 0 5px 0;
        font-size: 1.1rem;
        color: #333;
    }

    .lease-info .property {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .lease-info .dates {
        font-size: 0.8rem;
        color: #888;
    }

    .lease-info .dates.expired {
        color: #dc3545;
    }

    .lease-info .dates.active {
        color: #28a745;
    }

    .lease-meta {
        text-align: right;
    }

    .lease-meta .rent {
        font-size: 1.25rem;
        font-weight: 700;
        color: #28a745;
    }

    .lease-meta .rent-label {
        font-size: 0.75rem;
        color: #666;
    }

    .lease-card-body {
        display: none;
        padding: 15px 20px;
        border-top: 1px solid #eee;
    }

    .lease-card-body.show {
        display: block;
    }

    /* Document List inside Lease Card */
    .document-list {
        margin-top: 10px;
    }

    .document-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .document-item:last-child {
        margin-bottom: 0;
    }

    .document-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .document-info i {
        color: #dc3545;
        font-size: 1.2rem;
    }

    .document-info span {
        font-size: 0.9rem;
    }

    .document-actions {
        display: flex;
        gap: 6px;
    }

    .document-actions .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }

    /* Status Badges */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-badge.draft { background: #e9ecef; color: #495057; }
    .status-badge.generated { background: #cce5ff; color: #004085; }
    .status-badge.review { background: #e2d4f0; color: #6f42c1; }
    .status-badge.sent_for_signature { background: #b8daff; color: #004085; }
    .status-badge.signed { background: #c3e6cb; color: #155724; }
    .status-badge.invoice_created { background: #ffeeba; color: #856404; }
    .status-badge.package_sent { background: #bee5eb; color: #0c5460; }
    .status-badge.payment_pending { background: #ffc107; color: #333; }
    .status-badge.payment_received { background: #28a745; color: white; }
    .status-badge.completed { background: #28a745; color: white; }
    .status-badge.cancelled { background: #dc3545; color: white; }

    /* Term Status Badge (ACTIVE/EXPIRED) */
    .term-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 600;
        margin-left: 8px;
        text-transform: uppercase;
    }
    .term-badge.active { background: #28a745; color: white; }
    .term-badge.expired { background: #dc3545; color: white; }
    .term-badge.pending { background: #6c757d; color: white; }

    /* Pipeline Status Badge */
    .pipeline-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 500;
        margin-left: 4px;
    }

    .active-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-left: 8px;
    }

    .active-badge.active { background: #28a745; color: white; }
    .active-badge.expired { background: #dc3545; color: white; }

    /* Pipeline View Toggle */
    .pipeline-view-toggle {
        display: flex;
        gap: 5px;
    }
    .pipeline-view-toggle .btn.active {
        background: #404040;
        color: white;
    }

    /* Stage Assignee Avatar */
    .stage-assignee {
        margin-bottom: 5px;
    }
    .assignee-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Per-Lease Pipeline Progress */
    .lease-pipeline-progress {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 10px;
        padding: 8px 0;
        border-top: 1px solid #eee;
    }
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        min-width: 0;
    }
    .progress-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        color: #666;
        margin-bottom: 4px;
    }
    .progress-dot.completed {
        background: #28a745;
        color: white;
    }
    .progress-dot.current {
        background: #0066cc;
        color: white;
        animation: pulse 2s infinite;
    }
    .progress-step-label {
        font-size: 0.55rem;
        color: #999;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    .progress-connector {
        flex: 0 0 20px;
        height: 2px;
        background: #e9ecef;
        margin-bottom: 18px;
    }
    .progress-connector.completed {
        background: #28a745;
    }

    /* Stage Completion Slots */
    .stage-slots {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
        margin-top: 10px;
    }
    .stage-slot {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px;
        font-size: 0.8rem;
    }
    .stage-slot.completed {
        border-color: #28a745;
        background: #f8fff8;
    }
    .stage-slot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .stage-slot-name {
        font-weight: 600;
        font-size: 0.75rem;
    }
    .stage-slot-status {
        font-size: 0.7rem;
        color: #666;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0.4); }
        70% { box-shadow: 0 0 0 8px rgba(0, 102, 204, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0); }
    }

    /* Activity Feed */
    .activity-feed {
        max-height: 600px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* Activity icons for status-aligned types */
    .activity-icon.draft { background: #e9ecef; color: #495057; }
    .activity-icon.generated { background: #cce5ff; color: #0066cc; }
    .activity-icon.review { background: #e2d4f0; color: #6f42c1; }
    .activity-icon.sent_for_signature { background: #b8daff; color: #004085; }
    .activity-icon.signed { background: #c3e6cb; color: #155724; }
    .activity-icon.invoice_created { background: #ffeeba; color: #856404; }
    .activity-icon.package_sent { background: #bee5eb; color: #0c5460; }
    .activity-icon.payment_pending { background: #fff3cd; color: #856404; }
    .activity-icon.payment_received { background: #d4edda; color: #28a745; }
    .activity-icon.completed { background: #28a745; color: white; }
    .activity-icon.cancelled { background: #f8d7da; color: #721c24; }
    .activity-icon.note_added { background: #e2e3e5; color: #383d41; }
    .activity-icon.document_downloaded { background: #fff3cd; color: #856404; }
    .activity-icon.document_viewed { background: #d1ecf1; color: #0c5460; }
    .activity-icon.email_parsed { background: #d4edda; color: #155724; }
    /* Legacy activity types */
    .activity-icon.created { background: #d4edda; color: #28a745; }
    .activity-icon.document_created { background: #d4edda; color: #155724; }
    .activity-icon.downloaded { background: #fff3cd; color: #856404; }
    .activity-icon.status_changed { background: #d1ecf1; color: #0c5460; }
    .activity-icon.sent_email { background: #f8d7da; color: #721c24; }

    .activity-content {
        flex: 1;
    }

    .activity-content p {
        margin: 0;
        color: #333;
    }

    .activity-content .activity-description {
        font-size: 0.9rem;
        color: #555;
        margin-top: 4px;
    }

    .activity-content .meta {
        font-size: 0.8rem;
        color: #999;
        margin-top: 5px;
    }

    .activity-content .meta i {
        margin-right: 3px;
    }

    /* Filters */
    .filters-row {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-group label {
        font-size: 0.85rem;
        color: #666;
        white-space: nowrap;
    }

    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.85rem;
        min-width: 150px;
    }

    /* Client Accordion */
    .client-accordion {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .client-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f8f9fa;
        cursor: pointer;
        transition: background 0.2s;
    }

    .client-header:hover {
        background: #e9ecef;
    }

    .client-header h4 {
        margin: 0;
        font-size: 1rem;
        color: #333;
    }

    .client-leases {
        display: none;
        padding: 15px 20px;
        background: white;
    }

    .client-leases.show {
        display: block;
    }

    /* Sidebar Activity Panel */
    .activity-panel {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .activity-panel-header {
        padding: 15px 20px;
        background: #404040;
        color: white;
    }

    .activity-panel-header h3 {
        margin: 0;
        font-size: 1rem;
    }

    .activity-panel-content {
        padding: 15px;
        max-height: 500px;
        overflow-y: auto;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .empty-state i {
        font-size: 3rem;
        color: #ddd;
        margin-bottom: 15px;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .quick-actions .btn {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.show {
        display: flex;
    }

    .modal-box {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* Lease Actions */
    .lease-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'client_list' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Generate New Lease
        </a>
        <button class="btn btn-outline-secondary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card primary">
            <h3>{{ total_active }}</h3>
            <p>Active Leases</p>
        </div>
        <div class="stat-card danger">
            <h3>{{ total_expired }}</h3>
            <p>Expired Leases</p>
        </div>
        <div class="stat-card success">
            <h3>{{ total_completed }}</h3>
            <p>Completed</p>
        </div>
        <div class="stat-card warning">
            <h3>{{ status_counts.payment_pending|default:0 }}</h3>
            <p>Awaiting Payment</p>
        </div>
        <div class="stat-card info">
            <h3>${{ total_monthly_rent|floatformat:0 }}</h3>
            <p>Active Monthly Rent</p>
        </div>
    </div>

    <!-- Pipeline Status Overview -->
    <div class="pipeline-section">
        <div class="pipeline-header">
            <h2><i class="fas fa-stream"></i> Lease Pipeline</h2>
            <div class="pipeline-view-toggle">
                <button class="btn btn-sm btn-outline-secondary active" id="currentViewBtn" onclick="togglePipelineView('current')">Current</button>
                <button class="btn btn-sm btn-outline-secondary" id="cumulativeViewBtn" onclick="togglePipelineView('cumulative')">Cumulative</button>
            </div>
        </div>
        <div class="pipeline-stages">
            {% for step in pipeline_steps %}
            <div class="pipeline-stage {% if current_status_filter == step.value %}active{% endif %}"
                 onclick="filterByStatus('{{ step.value }}')"
                 data-stage="{{ step.value }}">
                <div class="stage-assignee" title="{{ step.assignee_email }}">
                    <img src="https://ui-avatars.com/api/?name={{ step.assignee_initials }}&size=24&background=random&color=fff"
                         alt="{{ step.assignee_email }}"
                         class="assignee-avatar">
                </div>
                <div class="count current-count">{{ step.current_count }}</div>
                <div class="count cumulative-count" style="display:none;">{{ step.cumulative_count }}</div>
                <div class="label">{{ step.label }}</div>
            </div>
            {% empty %}
            <!-- Fallback if pipeline_steps not available -->
            <div class="pipeline-stage {% if current_status_filter == 'draft' %}active{% endif %}" onclick="filterByStatus('draft')">
                <div class="count">{{ status_counts.draft|default:0 }}</div>
                <div class="label">Draft</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'generated' %}active{% endif %}" onclick="filterByStatus('generated')">
                <div class="count">{{ status_counts.generated|default:0 }}</div>
                <div class="label">Generated</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'review' %}active{% endif %}" onclick="filterByStatus('review')">
                <div class="count">{{ status_counts.review|default:0 }}</div>
                <div class="label">Review</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'sent_for_signature' %}active{% endif %}" onclick="filterByStatus('sent_for_signature')">
                <div class="count">{{ status_counts.sent_for_signature|default:0 }}</div>
                <div class="label">Sent</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'signed' %}active{% endif %}" onclick="filterByStatus('signed')">
                <div class="count">{{ status_counts.signed|default:0 }}</div>
                <div class="label">Signed</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'invoice_created' %}active{% endif %}" onclick="filterByStatus('invoice_created')">
                <div class="count">{{ status_counts.invoice_created|default:0 }}</div>
                <div class="label">Invoice</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'package_sent' %}active{% endif %}" onclick="filterByStatus('package_sent')">
                <div class="count">{{ status_counts.package_sent|default:0 }}</div>
                <div class="label">Pkg Sent</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'payment_pending' %}active{% endif %}" onclick="filterByStatus('payment_pending')">
                <div class="count">{{ status_counts.payment_pending|default:0 }}</div>
                <div class="label">Pending</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'payment_received' %}active{% endif %}" onclick="filterByStatus('payment_received')">
                <div class="count">{{ status_counts.payment_received|default:0 }}</div>
                <div class="label">Paid</div>
            </div>
            <div class="pipeline-stage {% if current_status_filter == 'completed' %}active{% endif %}" onclick="filterByStatus('completed')">
                <div class="count">{{ status_counts.completed|default:0 }}</div>
                <div class="label">Complete</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Left Column: Main Content -->
        <div class="main-column">
            <!-- Tabs -->
            <div class="tab-container">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="leases">
                        <i class="fas fa-file-contract"></i> All Leases
                    </button>
                    <button class="tab-btn" data-tab="by-client">
                        <i class="fas fa-users"></i> By Client
                    </button>
                    <button class="tab-btn" data-tab="activity">
                        <i class="fas fa-history"></i> Activity Log
                    </button>
                </div>

                <!-- All Leases Tab -->
                <div class="tab-content active" id="leases-tab">
                    <!-- Filters -->
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Status:</label>
                            <select id="statusFilter" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if current_status_filter == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Client:</label>
                            <select id="clientFilter" onchange="applyFilters()">
                                <option value="">All Clients</option>
                                {% for client in all_clients %}
                                <option value="{{ client.id }}" {% if current_client_filter == client.id|stringformat:"i" %}selected{% endif %}>{{ client.pOwner }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>

                    <!-- Lease Cards -->
                    {% if leases %}
                        {% for lease in leases %}
                        <div class="lease-card" data-lease-id="{{ lease.id }}">
                            <div class="lease-card-header" onclick="toggleLeaseCard('{{ lease.id }}')">
                                <div class="lease-info">
                                    <h4>
                                        {{ lease.client.pOwner }}
                                        <!-- Term Status Badge -->
                                        {% if lease.is_active %}
                                        <span class="term-badge active" title="Lease term is currently active">ACTIVE</span>
                                        {% elif lease.is_expired %}
                                        <span class="term-badge expired" title="Lease term has expired">EXPIRED</span>
                                        {% else %}
                                        <span class="term-badge pending" title="Lease term not yet started">PENDING</span>
                                        {% endif %}
                                        <!-- Pipeline Status Badge -->
                                        <span class="status-badge {{ lease.status }}" title="Pipeline: {{ lease.get_status_display }}">{{ lease.get_status_display }}</span>
                                    </h4>
                                    <div class="property">
                                        <i class="fas fa-home"></i> {{ lease.full_property_address }}
                                    </div>
                                    <div class="dates {% if lease.is_expired %}expired{% elif lease.is_active %}active{% endif %}">
                                        <i class="fas fa-calendar"></i>
                                        {{ lease.lease_start_date|date:"M d, Y" }} - {{ lease.lease_end_date|date:"M d, Y" }}
                                        {% if lease.is_renewal %}<span class="badge bg-info ms-2">Renewal</span>{% endif %}
                                    </div>
                                    <!-- Mini Pipeline Progress (rendered by JS) -->
                                    <div class="lease-pipeline-progress" data-status="{{ lease.status }}" onclick="event.stopPropagation();"></div>
                                </div>
                                <div class="lease-meta">
                                    <div class="rent">${{ lease.monthly_rent|floatformat:0 }}</div>
                                    <div class="rent-label">per month</div>
                                </div>
                            </div>
                            <div class="lease-card-body" id="lease-body-{{ lease.id }}">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Lessor Information</h6>
                                        <p><strong>{{ lease.lessor_name }}</strong></p>
                                        <p>{{ lease.lessor_phone }} | {{ lease.lessor_email }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Lease Terms</h6>
                                        <p>Security Deposit: ${{ lease.security_deposit|floatformat:0 }}</p>
                                        <p>{{ lease.bedrooms }} Bedrooms | {{ lease.rental_months }} Months</p>
                                    </div>
                                </div>

                                <h6 class="mt-3">Documents</h6>
                                <div class="document-list">
                                    {% for doc in lease.documents.all %}
                                    <div class="document-item">
                                        <div class="document-info">
                                            <i class="fas fa-file-pdf text-danger"></i>
                                            <span>{{ doc.get_document_type_display }}</span>
                                        </div>
                                        <div class="document-actions">
                                            {% if doc.file_path %}
                                            <a href="{% url 'view_lease_document' doc.id %}" class="btn btn-sm btn-outline-info" target="_blank" title="View PDF">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'download_lease_document' doc.id %}" class="btn btn-sm btn-outline-primary" title="Download PDF">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            {% else %}
                                            <span class="text-muted small">Not available</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <p class="text-muted">No documents generated yet.</p>
                                    {% endfor %}
                                </div>

                                <div class="lease-actions">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal('{{ lease.id }}', '{{ lease.status }}')">
                                        <i class="fas fa-edit"></i> Update Status
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="openNotesModal('{{ lease.id }}')">
                                        <i class="fas fa-sticky-note"></i> Add Note
                                    </button>
                                </div>

                                {% if lease.notes %}
                                <div class="mt-3">
                                    <h6>Notes</h6>
                                    <pre style="white-space: pre-wrap; font-size: 0.85rem; background: #f8f9fa; padding: 10px; border-radius: 6px;">{{ lease.notes }}</pre>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-file-contract"></i>
                            <h4>No Leases Found</h4>
                            <p>Generate your first lease documents to see them here.</p>
                            <a href="{% url 'client_list' %}" class="btn btn-primary mt-3">
                                <i class="fas fa-plus"></i> Generate Lease
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- By Client Tab -->
                <div class="tab-content" id="by-client-tab">
                    {% if clients_with_leases %}
                        {% for client in clients_with_leases %}
                        <div class="client-accordion">
                            <div class="client-header" onclick="toggleClientLeases({{ client.id }})">
                                <div>
                                    <h4>{{ client.pOwner }}</h4>
                                    <small class="text-muted">{{ client.pAddress }}</small>
                                </div>
                                <div>
                                    <span class="badge bg-primary">{{ client.lease_count }} lease{{ client.lease_count|pluralize }}</span>
                                    {% if client.active_lease_count > 0 %}
                                    <span class="badge bg-success">{{ client.active_lease_count }} active</span>
                                    {% endif %}
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </div>
                            </div>
                            <div class="client-leases" id="client-leases-{{ client.id }}">
                                <div class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin"></i> Loading leases...
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Clients with Leases</h4>
                            <p>Generate lease documents for a client to see them here.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Activity Tab -->
                <div class="tab-content" id="activity-tab">
                    <div class="activity-feed" id="activityFeed">
                        {% if recent_activity %}
                            {% for activity in recent_activity %}
                            <div class="activity-item">
                                <div class="activity-icon {{ activity.activity_type }}">
                                    {% if activity.activity_type == 'created' %}
                                    <i class="fas fa-plus"></i>
                                    {% elif activity.activity_type == 'generated' %}
                                    <i class="fas fa-folder-open"></i>
                                    {% elif activity.activity_type == 'document_created' %}
                                    <i class="fas fa-file-alt"></i>
                                    {% elif activity.activity_type == 'downloaded' %}
                                    <i class="fas fa-download"></i>
                                    {% elif activity.activity_type == 'status_changed' %}
                                    <i class="fas fa-exchange-alt"></i>
                                    {% elif activity.activity_type == 'note_added' %}
                                    <i class="fas fa-sticky-note"></i>
                                    {% else %}
                                    <i class="fas fa-info"></i>
                                    {% endif %}
                                </div>
                                <div class="activity-content">
                                    <p>
                                        <strong>{{ activity.lease.client.pOwner }}</strong>
                                        <span class="text-muted">({{ activity.lease.property_address|truncatechars:30 }})</span>
                                    </p>
                                    <p class="activity-description">{{ activity.description }}</p>
                                    <div class="meta">
                                        <span><i class="fas fa-user"></i> {{ activity.performed_by.email|default:"System" }}</span>
                                        &bull;
                                        <span><i class="fas fa-clock"></i> {{ activity.created_at|timesince }} ago</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <h4>No Recent Activity</h4>
                                <p>Activity will appear here as you work with leases.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Activity Panel -->
        <div class="sidebar-column">
            <div class="activity-panel">
                <div class="activity-panel-header">
                    <h3><i class="fas fa-bolt"></i> Recent Activity</h3>
                </div>
                <div class="activity-panel-content">
                    {% if recent_activity %}
                        {% for activity in recent_activity|slice:":10" %}
                        <div class="activity-item">
                            <div class="activity-icon {{ activity.activity_type }}">
                                {% if activity.activity_type == 'generated' %}
                                <i class="fas fa-folder-open"></i>
                                {% elif activity.activity_type == 'document_created' %}
                                <i class="fas fa-file-alt"></i>
                                {% elif activity.activity_type == 'status_changed' %}
                                <i class="fas fa-exchange-alt"></i>
                                {% elif activity.activity_type == 'note_added' %}
                                <i class="fas fa-sticky-note"></i>
                                {% else %}
                                <i class="fas fa-info"></i>
                                {% endif %}
                            </div>
                            <div class="activity-content">
                                <p><strong>{{ activity.lease.client.pOwner }}</strong></p>
                                <p>{{ activity.description|truncatechars:40 }}</p>
                                <div class="meta">
                                    {{ activity.performed_by.email|default:"System"|truncatechars:15 }} &bull;
                                    {{ activity.created_at|timesince }} ago
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No recent activity</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal-overlay" id="statusModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Update Lease Status</h3>
            <button class="btn btn-sm" onclick="closeStatusModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="statusModalLeaseId">
            <div class="form-group">
                <label>Select New Status:</label>
                <select id="newStatusSelect" class="form-control">
                    {% for value, label in status_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateStatus()">Update Status</button>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal-overlay" id="notesModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Add Note</h3>
            <button class="btn btn-sm" onclick="closeNotesModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="notesModalLeaseId">
            <div class="form-group">
                <label>Note:</label>
                <textarea id="noteText" class="form-control" rows="4" placeholder="Enter your note here..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNotesModal()">Cancel</button>
            <button class="btn btn-primary" onclick="addNote()">Add Note</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Pipeline status order for progress calculation
    const STATUS_ORDER = ['draft', 'generated', 'review', 'sent_for_signature', 'signed', 'invoice_created', 'package_sent', 'payment_pending', 'payment_received', 'completed'];
    const STATUS_LABELS = {
        'draft': 'Draft',
        'generated': 'Gen',
        'review': 'Rev',
        'sent_for_signature': 'Sent',
        'signed': 'Sign',
        'invoice_created': 'Inv',
        'package_sent': 'Pkg',
        'payment_pending': 'Pend',
        'payment_received': 'Paid',
        'completed': 'Done'
    };

    // Pipeline view toggle
    function togglePipelineView(view) {
        const currentBtn = document.getElementById('currentViewBtn');
        const cumulativeBtn = document.getElementById('cumulativeViewBtn');
        const currentCounts = document.querySelectorAll('.current-count');
        const cumulativeCounts = document.querySelectorAll('.cumulative-count');

        if (view === 'cumulative') {
            currentBtn.classList.remove('active');
            cumulativeBtn.classList.add('active');
            currentCounts.forEach(el => el.style.display = 'none');
            cumulativeCounts.forEach(el => el.style.display = 'block');
        } else {
            cumulativeBtn.classList.remove('active');
            currentBtn.classList.add('active');
            cumulativeCounts.forEach(el => el.style.display = 'none');
            currentCounts.forEach(el => el.style.display = 'block');
        }
    }

    // Render pipeline progress for each lease card
    function renderPipelineProgress() {
        document.querySelectorAll('.lease-pipeline-progress').forEach(container => {
            const currentStatus = container.dataset.status;
            const currentIndex = STATUS_ORDER.indexOf(currentStatus);

            let html = '';
            STATUS_ORDER.forEach((status, index) => {
                if (index > 0) {
                    const connectorClass = index <= currentIndex ? 'completed' : '';
                    html += `<div class="progress-connector ${connectorClass}"></div>`;
                }

                let dotClass = '';
                let dotContent = '';
                if (status === currentStatus) {
                    dotClass = 'current';
                } else if (index < currentIndex) {
                    dotClass = 'completed';
                    dotContent = '<i class="fas fa-check" style="font-size:0.5rem;"></i>';
                }

                html += `
                    <div class="progress-step">
                        <div class="progress-dot ${dotClass}" title="${STATUS_LABELS[status]}">
                            ${dotContent}
                        </div>
                        <div class="progress-step-label">${STATUS_LABELS[status]}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        });
    }

    // Initialize pipeline progress on page load
    document.addEventListener('DOMContentLoaded', function() {
        renderPipelineProgress();
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const tabId = this.dataset.tab + '-tab';
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Filter functions
    function filterByStatus(status) {
        document.getElementById('statusFilter').value = status;
        applyFilters();
    }

    function applyFilters() {
        const status = document.getElementById('statusFilter').value;
        const client = document.getElementById('clientFilter').value;
        const params = new URLSearchParams();
        if (status) params.set('status', status);
        if (client) params.set('client', client);
        window.location.href = '{% url "lease_manager" %}?' + params.toString();
    }

    function clearFilters() {
        window.location.href = '{% url "lease_manager" %}';
    }

    // Toggle lease card details
    function toggleLeaseCard(leaseId) {
        const body = document.getElementById('lease-body-' + leaseId);
        body.classList.toggle('show');
    }

    // Toggle client leases accordion
    function toggleClientLeases(clientId) {
        const container = document.getElementById('client-leases-' + clientId);
        const isShown = container.classList.contains('show');

        if (isShown) {
            container.classList.remove('show');
        } else {
            container.classList.add('show');
            loadClientLeases(clientId);
        }
    }

    // Load client leases via AJAX
    function loadClientLeases(clientId) {
        const container = document.getElementById('client-leases-' + clientId);

        fetch(`{% url 'get_leases_by_client' 0 %}`.replace('0', clientId))
            .then(response => response.json())
            .then(data => {
                if (data.success && data.leases.length > 0) {
                    let html = '';
                    data.leases.forEach(lease => {
                        const activeBadge = lease.is_active ? '<span class="active-badge active">ACTIVE</span>' :
                                           lease.is_expired ? '<span class="active-badge expired">EXPIRED</span>' : '';
                        html += `
                            <div class="lease-card" style="margin-bottom: 10px;">
                                <div class="lease-card-header" style="padding: 12px 15px;">
                                    <div class="lease-info">
                                        <h4 style="font-size: 1rem;">${lease.lessor_name} ${activeBadge}</h4>
                                        <div class="property" style="font-size: 0.85rem;">${lease.property_address}</div>
                                        <div class="dates" style="font-size: 0.75rem;">
                                            ${lease.lease_start_date} - ${lease.lease_end_date}
                                        </div>
                                    </div>
                                    <div class="lease-meta">
                                        <div class="rent" style="font-size: 1.1rem;">$${lease.monthly_rent || 0}</div>
                                        <span class="status-badge ${lease.status}">${lease.status_display}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center py-3 text-muted">No leases found for this client.</div>';
                }
            })
            .catch(error => {
                container.innerHTML = '<div class="text-center py-3 text-danger">Error loading leases.</div>';
                console.error('Error:', error);
            });
    }

    // Status Modal
    function openStatusModal(leaseId, currentStatus) {
        document.getElementById('statusModalLeaseId').value = leaseId;
        document.getElementById('newStatusSelect').value = currentStatus;
        document.getElementById('statusModal').classList.add('show');
    }

    function closeStatusModal() {
        document.getElementById('statusModal').classList.remove('show');
    }

    function updateStatus() {
        const leaseId = document.getElementById('statusModalLeaseId').value;
        const newStatus = document.getElementById('newStatusSelect').value;

        fetch('{% url "update_lease_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                lease_id: leaseId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeStatusModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating status');
            console.error('Error:', error);
        });
    }

    // Notes Modal
    function openNotesModal(leaseId) {
        document.getElementById('notesModalLeaseId').value = leaseId;
        document.getElementById('noteText').value = '';
        document.getElementById('notesModal').classList.add('show');
    }

    function closeNotesModal() {
        document.getElementById('notesModal').classList.remove('show');
    }

    function addNote() {
        const leaseId = document.getElementById('notesModalLeaseId').value;
        const note = document.getElementById('noteText').value;

        if (!note.trim()) {
            alert('Please enter a note');
            return;
        }

        fetch('{% url "add_lease_note" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                lease_id: leaseId,
                note: note
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeNotesModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error adding note');
            console.error('Error:', error);
        });
    }

    function refreshDashboard() {
        location.reload();
    }

    // Close modals on outside click
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });
</script>
{% endblock %}

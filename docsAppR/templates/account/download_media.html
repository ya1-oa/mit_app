{% extends "account/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Column - Media Downloader -->
        <div class="col-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Download Encircle Media</h2>
                </div>
                
                <div class="card-body">
                    {% if messages %}
                    <div class="scroll-cards">
                        {% for message in messages %}
                        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="claim_id" class="form-label">Property Claim ID</label>
                            <input type="text" class="form-control form-control-styled" id="claim_id" name="claim_id" 
                                   placeholder="Enter claim ID (e.g. 123456)" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="room_filter" class="form-label">Room Filter (Leave blank to download all rooms images)</label>
                            <input type="text" class="form-control form-control-styled" id="room_filter" name="room_filter"
                                   placeholder="Comma-separated rooms (e.g. 'Living Room, Kitchen')">
                            <small class="form-text text-muted">Only use this if you don't want to download all images but specific rooms instead</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-styled">Download Media</button>
                    </form>
                    
                    <div class="mail-info mt-3">
                        <p><strong>How it works:</strong></p>
                        <p>Media files will be downloaded directly to a zip file with the following structure:</p>
                        <p><code>claim_3793680_media.zip<br>
                        ├── Main Building/<br>
                        │   ├── 601 Foyer DN FRT.jpg<br>
                        │   ├── 603 Living Room DN.png<br>
                        │   └── ...<br>
                        ├── unlabeled_media/<br>
                        │   ├── 002_OH24CHERRY 600 HMR DMO & WIP V2.pdf<br>
                        │   └── ...<br>
                        └── ...</code></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - List Creation -->
        <div class="col-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h2>Create Room Template</h2>
                </div>
                
                <div class="card-body">
                    <form id="templateForm" enctype="multipart/form-data" method="post" action="{% url 'automate' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control form-control-styled" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control form-control-styled" id="password" name="password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="template_name" class="form-label">Template Name</label>
                            <input type="text" class="form-control form-control-styled" id="template_name" name="template_name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="excel_file" class="form-label">Excel File</label>
                            <input type="file" class="form-control-file form-file-styled" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                            <small class="form-text text-muted">Must be the jobinfo(3) tab with proper column structure</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-styled">Create Rooms</button>
                    </form>
                    
                    <div id="status" class="mt-3"></div>
                    
                    <div class="instructions mt-4">
                        <h5>Excel File Requirements:</h5>
                        <ul>
                            <li>Must contain 'jobinfo(3)' worksheet tab</li>
                            <li>Columns A-B and D-E for basic room info</li>
                            <li>Columns I-K and M-O for SOURCE OF LOSS</li>
                            <li>Columns R-T and V-X for DMO sections</li>
                            <li>Columns Z-AA and AC-AD for FSI sections</li>
                            <li>Columns AF-AG and AH-AI for WTF MIT sections</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('templateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const statusDiv = document.getElementById('status');
    statusDiv.innerHTML = '<div class="alert alert-info">Processing Excel file and creating rooms...</div>';
    
    try {
        const formData = new FormData(e.target);
        const response = await fetch(e.target.action, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'completed') {
            const summary = data.processing_summary || {};
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Success!</strong><br>
                    Template "${data.template_name}" created with ${summary.rooms_added} rooms.<br>
                    ${summary.errors_encountered || 0} errors encountered.
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${data.error || 'Unknown error occurred during processing'}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> ${error.message || 'Failed to submit form'}
            </div>
        `;
    }
});
</script>

<style>
.container-fluid {
    padding: 20px;
}
.row {
    display: flex;
    flex-wrap: nowrap;
}
.col-6 {
    width: 50%;
    padding-right: 15px;
    padding-left: 15px;
}
.card {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.card-header {
    background-color: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
}
.mail-info, .instructions {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 20px;
}
.scroll-cards {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 15px;
}

/* Enhanced Form Styling */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    margin-bottom: 8px;
    display: block;
}

.form-control-styled {
    height: 45px;
    padding: 12px 15px;
    font-size: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    width: 100%;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-control-styled:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    outline: none;
}

.form-file-styled {
    padding: 10px 15px;
    font-size: 14px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    width: 100%;
    background-color: #fff;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.form-file-styled:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    outline: none;
}

.form-text {
    margin-top: 5px;
    font-size: 12px;
}

.btn-styled {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    width: 100%;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.btn-styled:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
</style>
{% endblock %}
